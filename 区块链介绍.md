# 1、什么是区块链网络？

区块链网络是一种技术基础设施，为应用程序提供分类账和智能合约（打包为“链码”的一部分）服务。

**智能合约**主要用于生成交易，这些交易随后会被分发到网络中的每个对等节点，并在它们的账本副本中被永久记录。应用程序的用户可以是使用客户端应用程序的最终用户，也可以是区块链网络管理员。

在大多数情况下，多个组织共同组成一个通道，在该通道上通过链码进行交易，权限由最初配置通道时商定的一系列政策决定。此外，经各组织同意，政策可随时间推移而改变。

"网络 "和 "通道"，在 Hyperledger Fabric 中，这些术语实际上是同义词，因为它们都是指在一个定义的结构中管理组织间交互的组织、组件、政策和流程的统称。

# 2、一个区块链网络样例

区块链网络最终目标，如下为区块链网络样例的最终状态。

![network.1](https://github.com/hyperledger/fabric/raw/main/docs/source/network/network.diagram.1.png)

**组织**：R1、R2、R0。为网络贡献基础设施，帮助组建网络

这些基础设施实现了区块链网络，并受组成网络的各组织商定的政策管理。例如，谁可以添加新的组织。

三个组织 R1、R2 和 R0 共同决定建立一个网络。该网络有一个所有组织都同意的**配置** CC1，其中列出了各组织的定义以及定义各组织在通道上扮演的角色的策略。

在这个通道上，R1 和 R2 将把名为 P1 和 P2 的**对等节点**加入**通道** C1，而 R0 则拥有通道的**订购服务** O。所有这些节点都将包含该通道的**分类账副本**（L1），该分类账是记录交易的地方。

请注意，订购服务保存的分类账副本不包含状态数据库。

R1 和 R2 还将通过它们拥有的**应用程序** A1 和 A2 与通道进行交互。**这三个组织都有一个证书颁发机构**，为其组织的节点、管理员、组织定义和应用程序生成必要的证书。

# 3、创建网络

创建网络或通道的第一步是**同意并确定其配置**：

![network.2](https://github.com/hyperledger/fabric/raw/main/docs/source/network/network.diagram.2.png)

通道配置 CC1 已得到 R1、R2 和 R0 组织的同意，并包含在一个称为 "**配置块** "的块中，通常由 `configtxgen` 工具根据 `configtx.yaml` 文件创建。

一个组织可以单方面创建一个频道，然后邀请其他组织加入（我们将在 "添加一个组织到现有频道 "一文中探讨），但现在我们假设这些组织从一开始就希望在频道上合作。

一旦有了配置块，就可以说通道在逻辑上已经存在，即使没有任何组件与之物理连接。该配置块包含可加入组件并在通道上交互的组织记录，以及定义如何做出决策和达成特定结果的结构的策略。虽然对等设备和应用程序是网络中的关键角色，但它们在通道中的行为更多是由通道配置策略决定的。

这些组织的定义及其管理员的身份必须由与每个组织相关的证书颁发机构（CA）创建。在我们的示例中，组织 R1、R2 和 R0 的证书和组织定义分别由 CA1、CA2 和 CA0 创建。创建 CA 后，请查看注册和注册 CA 身份，了解如何定义组织以及为管理员和节点创建身份。

# 4、证书颁发机构（CA）

证书颁发机构在网络中发挥着关键作用，因为它们颁发的 X.509 证书可用来**识别属于某个组织的组件**。CA 颁发的证书还可用于**签署交易**，以**表明某个组织认可交易结果**--这是交易结果被账本接受的先决条件。让我们来详细了解一下 CA 的这两个方面。

首先，区块链网络的不同组件使用证书相互识别自己来自特定组织。这就是为什么支持区块链网络的 CA 通常不止一个 -- 不同的组织通常使用不同的 CA。我们将在通道中使用三个 CA；每个组织一个。

证书与成员组织的映射是通过一种称为 "**成员服务提供商（MSP）**"的结构来实现的，该结构通过创建一个与根 CA 证书绑定的 MSP 来定义一个组织，以识别由根 CA 创建的组件和身份。然后，通道配置可以通过策略为组织分配特定的权利和权限（赋予特定组织（如 R1）向通道添加新组织的权利）。

其次，我们稍后会看到 CA 签发的证书如何成为交易生成和验证流程的核心。具体来说，X.509 证书用于客户端应用程序交易提出和智能合约交易响应，以对交易进行数字签名。随后，托管分类账副本的网络节点在接受分类账上的交易之前，会验证交易签名是否有效。

# 5、将节点加入通道

对等方是网络的基本要素，因为它们承载着分类账和链码（包含智能合约），因此是在通道上进行交易的组织连接到通道的物理点之一（另一个物理点是应用程序）。一个对等方可隶属于一个组织认为合适的多个渠道（取决于对等方 pod 的处理限制和特定国家的数据驻留规则等因素）。

另一方面，排序服务会从应用程序中收集已认可的交易，并将其排序为**交易块**，随后分发到通道中的每个对等节点。在每个提交的对等节点上，交易都会被记录下来，分类账的本地副本也会得到适当更新。**订购服务**是特定通道所独有的，为该通道提供服务的节点也被称为 "同意者集"。即使一个节点（或一组节点）为多个通道提供服务，每个通道的订购服务也被视为订购服务的一个独立实例。

由于 R1、R2 和 R0 已列入通道配置，因此它们可以加入对等体（R1 和 R2）或订购节点（R0）到通道。

![network.3](https://github.com/hyperledger/fabric/raw/main/docs/source/network/network.diagram.3.png)

R1 的**对等节点 P1**、R2 的**对等节点 P2** 和 R0 的**订购服务 O** 通过创建通道教程中描述的过程加入通道。属于每个组织的节点都有与该组织相关的证书颁发机构为其创建的 x.509 证书。P1 的证书由 CA1 创建，P2 的证书由 CA2 创建，以此类推。

通道中的**每个节点都会存储一份通道分类账 L1 的副本**，该副本会随着每个新区块的出现而更新（请注意，订购服务只包含分类账的区块链部分，而不包含状态数据库）。因此，我们可以认为 L1 物理上托管在 P1 上，但逻辑上托管在通道 C1 上。最好的做法是让 R1 和 R2 将它们的对等方 P1 和 P2 作为锚对等方，因为这将启动 R1 和 R2 之间的网络通信。

订购服务添加到通道后，可以对通道配置提出更新建议并提交更新，但几乎不能做其他操作。接下来，您必须在通道上安装、批准和提交链码。

# 6、安装、批准和提交链码

链码安装在对等节点上，然后在通道上定义和提交：

![network.4](https://github.com/hyperledger/fabric/raw/main/docs/source/network/network.diagram.4.png)

在 Fabric 中，定义对等组织如何与分类账交互的业务逻辑（例如，改变资产所有权的交易）包含在**智能合约**中。包含智能合约的结构称为**链码**（chaincode），安装在相关对等节点上，由相关对等组织批准，并在通道上提交。这样，您就可以把 chaincode 视为物理上托管在对等节点，但逻辑上托管在通道。在我们的示例中，链码 S5 安装在每个对等节点上，尽管组织不需要安装每个链码。请注意，订购服务并没有安装链码，因为订购节点通常不会提交交易。**安装、批准和提交链码的过程称为链码的 "生命周期"。**

链码定义中最重要的信息是**背书策略**。它描述了哪些组织必须认可交易，其他组织才能将其纳入自己的分类账副本。根据使用情况，背书策略可以设置为通道中成员的任意组合。如果未设置背书策略，则会继承通道配置中指定的默认背书策略。

请注意，虽然有些链码可以在通道上的成员之间创建私人数据交易，但私人数据不属于本主题的讨论范围。

虽然从技术上讲，现在可以使用对等 CLI 来驱动事务，但最佳做法是创建一个应用程序，用它来调用 chaincode 上的事务。

# 7、在通道上使用应用程序

智能合约提交后，客户端应用程序可通过 Fabric Gateway 服务（网关）在链码上调用交易。这就完成了我们在第一张图片中展示的结构：

![network.1](https://github.com/hyperledger/fabric/raw/main/docs/source/network/network.diagram.1.png)

与对等方和订购方一样，客户端应用程序也有一个与组织相关联的身份。在我们的例子中，**客户端应用程序 A1** 与组织 R1 关联，并与 C1 连接。

从 Fabric v2.4 开始，客户端应用程序（使用网关 SDK v1.x 开发）与网关服务建立 gRPC 连接，然后由网关服务代表应用程序处理事务提议和认可流程。**交易提出**是链码的**输入**，链码利用它生成**交易响应**。

我们可以看到，我们的 peer 组织 R1 和 R2 完全参与了通道。它们的 application 可以通过智能合约 S5 访问分类账 L1，生成由背书策略中指定的组织背书并写入分类账的 transaction。

# 8、将组件连接到多个通道

为了展示 Fabric 组件如何加入多个通道，我们将把 R2 及其同级 P2 加入新通道，而不加入 R1 和 P1。

## 8.1、创建新通道配置

创建通道的第一步是创建其配置。

该通道不仅包括 R2 和 R0，还包括一个新组织 R3，它的身份和证书已由 CA3 创建。R1 对该通道没有任何权限，也不能将组件加入该通道。事实上，它根本无法知道它的存在！

![network.5](https://github.com/hyperledger/fabric/raw/main/docs/source/network/network.diagram.5.png)

和之前一样，既然**通道配置 CC2** 已经创建，那么即使没有组件连接到通道上，通道在逻辑上也是存在的。

因此，让我们为它添加一些组件！

## 8.2、为新通道添加组件

和 C1 一样，让我们的组件加入 C2。由于我们已经展示了所有通道都有一个分类账（ledge），以及链码是如何安装在对等节点上并提交到通道的（在本例中，链码被称为 S6），因此我们暂时跳过这些步骤，来展示 C2 的最终状态。请注意，这个通道有自己的分类账 L2，它与 C1 的分类账是完全独立的。这是因为，尽管 R2（及其对等节点 P2）同时加入了两个通道，但这两个通道是完全独立的管理域。

![network.6](https://github.com/hyperledger/fabric/raw/main/docs/source/network/network.diagram.6.png)

请注意，虽然 C1 和 C2 都加入了同一个订购方组织 R0，但**每个通道都有不同的订购节点**。这并不是一个强制性配置，因为即使同一个订购节点加入了多个通道，每个通道也有一个单独的订购服务实例，这在多个订购方组织共同为订购服务提供节点的通道中更为常见。请注意，**只有加入特定通道的订购节点才拥有该通道的分类账**。

虽然 R2 也可以部署一个新的peer加入通道 C2，但在这种情况下，他们选择将 P2 部署到 C2。请注意，P2 的文件系统中既有 C1 的分类账（称为 L1），也有 C2 的分类账（称为 L2）。同样，R2 选择修改其应用程序 A2，以便能与 C2 一起使用，而 R3 的应用程序 A3 则与 C2 一起使用。

从逻辑上讲，这与 C1 的创建非常相似。两个对等组织与一个订购组织共同创建一个通道，并将组件和链码加入其中。

从连接到两个通道的 R2 的角度来考虑这种配置。从他们的角度来看，他们可能会把 C1 和 C2 以及他们连接到这两个通道的组件视为 "网络"，尽管这两个通道彼此不同。从这个意义上说，"网络 "也可以看作是存在于某个特定组织中的 "我所加入的所有通道和我所拥有的所有组件"。

现在，我们已经展示了如何将组织及其组件加入到多个通道中，下面我们来谈谈如何将组织及其组件添加到现有通道中。

# 9、将组织添加到现有通道

随着通道的成熟，其配置自然也会成熟，反映出世界的变化，而这些变化必须反映在通道中。修改通道的常见方式之一就是添加新的组织。虽然也可以添加更多的订购者组织（他们可以贡献自己的节点，也可以不贡献），但在本例中，我们将描述一个对等组织 R3 如何被添加到通道 C1 的通道配置 CC1 中的过程。

请注意，权利和权限是在通道级别定义的。一个组织是一个通道的管理员，并不意味着它也是另一个通道的管理员。每个通道都是一个独立的管理区，可根据其服务的使用案例进行完全定制。

![network.7](https://raw.githubusercontent.com/jinxiao-netpig/user-image/master/imgs/202504261929710.png)

虽然图表的更新看起来只是一个简单的步骤，但在通道中添加一个新的组织，从高层次上讲，需要三个步骤：

1. 决定新组织的权限和角色。这些权限的全部范围必须在 R3 添加到 C1 之前商定，超出了本专题的范围，但包含了首先创建通道时必须回答的同类问题。R3 在 C1 上有什么样的权限和权利？它是通道的管理员吗？它对任何通道资源的访问是否会受到限制（例如，R3 可能只能写入 C1，这意味着它可以提议更改，但不能签署）？R3 将在其对等设备上安装什么链码？
2. 更新通道，包括相关的链码，以反映这些决策。
3. 组织将其对等节点（可能还有订购节点）加入通道并开始参与。

在本主题中，我们假设 R3 将加入 C1，享有与 R1 和 R2 相同的权利和地位。同样，R3 也将作为 S5 链码的认可者加入，这意味着 R1 或 R2 必须重新定义 S5（特别是链码定义中的认可策略部分）并在通道上批准。

更新通道配置会创建一个新的配置块 CC1.1，它将作为通道配置，直到再次更新为止。请注意，即使配置发生了变化，通道仍然存在，P1 和 P2 仍然加入到通道中。无需向通道重新添加组织或对等设备。

## 9.1、将现有组件添加到新加入的通道

现在，R3 可以完全参与通道 C1，它可以将自己的组件添加到通道中。与其一个组件一个组件地添加，不如让我们来展示一下如何同时加入其对等节点、分类账本地副本、智能合约和客户端应用程序！

![network.8](https://raw.githubusercontent.com/jinxiao-netpig/user-image/master/imgs/202504261953658.png)

在本例中，R3 将先前与 C2 连接的 P3 添加到 C1。这样，P3 就会调用 C1 的分类账 L1。正如我们在上一节中提到的，R3 被添加到 C1 中，具有与 R1 和 R2 相同的权限。同样，由于链码 S5 已在通道上重新定义和批准，将 R3 包括在内，R3 现在可以安装 S5 并开始交易。正如 R2 修改了其应用程序 A2，使其能与通道 C2 一起使用一样，A3 现在也能在 C1 上调用交易。

# 10、网络回顾

本专题涉及的内容很多。我们从两个组织在一个通道上进行交易的简单配置，到多个组织在多个通道上进行交易，以及将一个组织加入已经存在的通道的过程。

虽然这个主题代表了一个相对简单的案例，但在 Fabric 中可以实现无穷无尽的复杂拓扑结构组合，支持无穷无尽的运营目标，而且理论上对网络的规模没有限制。通过谨慎使用网络和通道策略，即使是大型网络也能得到很好的管理。

















































